/*
 * YY Live Player - jQuery / Zepto plugin for YY live video player
 *
 * Auther: Rio Kwok
 *
 * Version: 0.3.0
 */
var YYLivePlayer=function(a,b){var i,j,k,l,m,n,o,c=this,d={YYLiveEvents:{noStream:"yylive_noStream",endStream:"yylive_endStream"}},e={sid:null,ssid:null,uid:null,appid:null,liveURL:null,hasPoster:!0,hasPlayBtn:!0,hasPauseBtn:!0,needLoading:!0,autoplay:!0,wrapper:"#yyLivePlayerWrapper",poster:".yyLivePlayer-poster",player:".yyLivePlayer",playBtn:".yyLivePlayer-playBtn",pauseBtn:".yyLivePlayer-pauseBtn",loadingImg:"data:image/gif;base64,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",eventListeners:{yylive_noStream:null,yylive_endStream:null},nonsupportHandler:null,liveInfoFunc:null,callSetMedia:!0},f={videoStreamState:0,isIOS:/iPhone|iPod|iPad/i.test(navigator.userAgent),isUCWEB:/UCWEB|UCBrowser/i.test(navigator.userAgent),isOpera:/Opera|Oupeng/i.test(navigator.userAgent),isFF:/Firefox/i.test(navigator.userAgent),isQQBrowser:/MQQBrowser/i.test(navigator.userAgent),is360Browser:/360 Aphone Browser/i.test(navigator.userAgent),isLieBao:/LieBao/i.test(navigator.userAgent),isSmartis:/SANFRANCISCO/i.test(navigator.userAgent),isBaiduBrowser:/baidubrowser/i.test(navigator.userAgent)},g="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),h={UCWEB:{regExpPrefix:"UCWEB|UCBrowser",iOS:{before:null,equals:null,after:null},android:{}}};b=b||{},b=a.extend(!0,e,b),b.ssid=b.ssid||b.sid,c.config=b,c.state=f,i=function(a,b){var e,f,c=g,d=[];if(b=b||c.length,a)for(e=0;a>e;e++)d[e]=c[0|Math.random()*b];else for(d[8]=d[13]=d[18]=d[23]="-",d[14]="4",e=0;36>e;e++)d[e]||(f=0|16*Math.random(),d[e]=c[19==e?8|3&f:f]);return d.join("")},j=function(){return i().replace(/-/gm,"")},k=function(){if(c.state.isIOS){if(c.state.isQQBrowser)return a.isFunction(c.config.nonsupportHandler)&&c.config.nonsupportHandler.apply(c),!1;if(l("iOS"))return a.isFunction(c.config.nonsupportHandler)&&c.config.nonsupportHandler.apply(c),!1}else{if(c.state.isOpera||c.state.isFF)return a.isFunction(c.config.nonsupportHandler)&&c.config.nonsupportHandler.apply(c),!1;if(c.state.isSmartis&&(c.state.is360Browser||c.state.isLieBao))return a.isFunction(c.config.nonsupportHandler)&&c.config.nonsupportHandler.apply(c),!1;var b=navigator.userAgent.match(/Android ([0-9.]+);/);if(b&&2==b.length&&(b=b[1],parseFloat(b)<4))return a.isFunction(c.config.nonsupportHandler)&&c.config.nonsupportHandler.apply(c),!1;if(l("android"))return a.isFunction(c.config.nonsupportHandler)&&c.config.nonsupportHandler.apply(c),!1}return!0},l=function(b){var d,e;for(e in h)if(c.state["is"+e]){if(!h[e][b])break;if(d=new RegExp("(?:"+h[e].regExpPrefix+")/([0-9.]+)","i").exec(navigator.userAgent),!d||0==d.lenght)break;if(d=d[1],h[e][b].before&&h[e][b].before>d)return!0;if(h[e][b].equals&&a.isArray(h[e][b].equals)&&h[e][b].equals.length>0&&h[e][b].equals.indexOf(d)>=0)return!0;if(h[e][b].after&&h[e][b].after<d)return!0}return!1},m=c.config.liveInfoFunc||function(b){a.ajax({url:"http://webaccess.service.yy.com:8000/querypresenter",data:{appid:"49",topsid:c.config.sid,subsid:c.config.ssid},dataType:"jsonp",jsonp:"jsonpcb",error:function(){console.log("err"),b.failHandler()},success:function(a){a&&0===a.code&&a.uids&&a.uids.length>=1?b.succHandler():(console.log("offline"),b.failHandler())}})},n=function(){function g(){setTimeout(function(){var d,e,f,b=c.player.attr("poster");b&&""!=b&&(c.player.attr("poster",""),c.player.attr("poster",b),d=a(window).scrollTop(),a(window).scrollTop(d+1),a(window).scrollTop(d),c.player.height(c.player.height()-1),c.player.height(c.player.height()+1)),c.config.hasPlayBtn&&(e=c.playBtn.css("background-image"),c.playBtn.css("background-image","none"),c.playBtn.css("background-image",e)),c.config.hasPauseBtn&&(f=c.pauseBtn.css("background-image"),c.pauseBtn.css("background-image","none"),c.pauseBtn.css("background-image",f))},3e3)}function h(){c.player.attr("data-init","true"),c.player.on("playing",function(){a(this).removeAttr("data-delayLimit")}).on("error",function(){if("true"===c.player.attr("data-init"))return c.player.attr("data-init",""),void 0;if("true"===c.player.attr("data-clean"))return c.player.attr("data-clean",""),void 0;var b=a(this).attr("data-delayLimit");return b>9?(c.pauseVideo(),c.playVideo(),void 0):(b++,a(this).attr("data-delayLimit",b),4==this.error.code&&this.load(),setTimeout(function(){c.pauseVideo(),c.playVideo()},500),void 0)})}function i(){c.player.one("play",function(){var a=!1;c.player.one("playing",function(){a=!0}),setTimeout(function(){a||c.pauseVideo()},1e4)})}function j(){c.playVideo()}function k(){setInterval(function(){m.call(c,{failHandler:function(){c.player.hasClass("play")&&(c.pauseVideo(),c.player.trigger(c.getYYLivePlayerEvent("endStream")))},succHandler:function(){console.log("online")}})},2e4)}var f,b=["isUCWEB","isOpera","isFF","isQQBrowser","is360Browser","isLieBao","isBaiduBrowser"],d=c.state.isIOS?"I_":"A_",e={loadVideoExptHandler:function(){},runAutoplay:function(){},onPlay:function(){},onPause:function(){}};for(f in b)if(c.state[b[f]]){d+=("0"+f).substr(-2);break}switch(c.state.isIOS?(e.loadVideoExptHandler=i,e.onPause=function(){c.player.on("pause",function(){c.pauseVideo()})}):(e.loadVideoExptHandler=h,e.onPause=function(){c.player.on("pause",function(){(3===c.player.get(0).readyState||4===c.player.get(0).readyState)&&c.pauseVideo()})}),d){case"I_00":k();break;case"A_00":k(),e.runAutoplay=j,e.onPlay=function(){c.player.on("play",function(){c.playVideo()})},e.onPause=function(){};break;case"A_03":k(),e.onPlay=function(){c.player.on("play",function(){c.playVideo()})},e.onPause=function(){},c.player.on(c.getYYLivePlayerEvent("endStream"),function(){c.player.hide()}),c.player.on(c.getYYLivePlayerEvent("noStream"),function(){c.player.hide()});break;case"A_04":g(),e.onPlay=function(){c.player.on("play",function(){var b=a(window).scrollTop();a(window).scrollTop(b+1),a(window).scrollTop(b),c.player.height(c.player.height()-1),c.player.height(c.player.height()+1)})};break;case"A_05":g();break;case"A_06":e.runAutoplay=j}return e},o=function(){var b,d;if(k()){if(c.config.callSetMedia){if(null==c.config.sid||""===c.config.sid)return console.log("sid is missing."),null;if(null==c.config.uid||""===c.config.uid)return console.log("uid is missing."),null;if(null==c.config.liveURL||""===c.config.liveURL)return console.log("liveURL is missing."),null}c.wrapper=a(c.config.wrapper),c.player=a(c.config.player),c.player.removeAttr("controls"),c.config.hasPoster&&(c.poster=a(c.config.poster)),c.config.hasPlayBtn&&(c.playBtn=a(c.config.playBtn)),c.config.hasPauseBtn&&(c.pauseBtn=a(c.config.pauseBtn)),b=n(),c.config.callSetMedia&&c.setMedia(c.config.liveURL),c.config.needLoading&&(c.loading=a("<div></div>"),c.player.after(c.loading),c.loading.css({position:"absolute",top:"0",left:"0",display:"none",height:"100%",width:"100%","background-color":"rgba(0,0,0, 0.5)","background-image":'url("'+c.config.loadingImg+'")',"background-position":"center","background-repeat":"no-repeat","background-size":"0.5rem 0.5rem","z-index":"10"}),c.player.on("play",function(){c.loading.show()}).on("timeupdate",function(){c.loading.hide()}).on("pause",function(){c.loading.hide()}).on("ended",function(){c.loading.hide()}).on("error",function(){c.loading.hide()}));for(d in c.config.eventListeners)a.isFunction(c.config.eventListeners[d])&&c.player.on(d,c.config.eventListeners[d]);b.loadVideoExptHandler(),b.onPause(),b.onPlay(),c.player.on("play",function(){c.player.attr("src")!=c.player.attr("data-src")&&(c.player.attr("src",c.player.attr("data-src")),c.player.get(0).play())}).on("pause",function(){c.player.removeClass("play")}).on("ended",function(){c.pauseVideo(),c.player.trigger(c.getYYLivePlayerEvent("endStream"))}),a(window).scrollTop(1),a(window).scrollTop(0)}},c.requestMedia=function(){m.call(c,{failHandler:function(){c.state.videoStreamState=2,c.playBtn.hide(),c.player.trigger(c.getYYLivePlayerEvent("noStream"))},succHandler:function(){c.liveURL=c.config.liveURL.replace("@sid",c.config.sid).replace("@ssid",c.config.ssid).replace("@uid",c.config.uid).replace("@appid",c.config.appid)+"&uuid="+j(),c.player.attr("data-src",c.liveURL),c.state.videoStreamState=1,c.state.autoplay&&fixingObj.runAutoplay()}})},c.cleanVideo=function(){this.player.attr("data-clean","true"),this.player.attr("src",""),this.player.removeClass("play")},c.getYYLivePlayerEvent=function(a){return d.YYLiveEvents[a]},c.checkVideoStream=function(){var a;c.checkVideoStream.ts&&clearInterval(c.checkVideoStream.ts),c.checkVideoStream.ts=setInterval(function(){var b=c.player.get(0),d=b.error&&b.error.code;if(c.player.hasClass("play")){if(4===d)return clearInterval(c.checkVideoStream.ts),c.player.trigger("ended"),void 0;4===a&&4!==b.readyState&&(clearInterval(c.checkVideoStream.ts),c.player.trigger("ended")),a=b.readyState}else clearInterval(c.checkVideoStream.ts)},5e3)},o()};YYLivePlayer.prototype={pauseVideo:function(){return this.player.hasClass("play")&&(this.player.get(0).pause(),this.cleanVideo(),this.config.hasPoster&&this.poster.show(),this.player.removeClass("play")),this},playVideo:function(){var b,a=this;return 2===a.state.videoStreamState?this:(a.config.hasPoster&&a.poster.hide(),b=a.player.get(0),(!a.player.hasClass("play")||a.state.isIOS&&a.state.isUCWEB)&&(a.config.hasPoster&&a.poster.hide(),a.player.show(),a.player.attr("src",a.player.attr("data-src")),a.player.height(a.player.height()-1),a.player.height(a.player.height()+1),$(window).scrollTop(1),$(window).scrollTop(0),b.load(),b.play(),a.player.addClass("play"),a.checkVideoStream()),setTimeout(function(){(4===b.readyState||5===b.readyState)&&b.play()},3e3),this)},bindEvent:function(a,b){return this.player.on(a,b),this},unbindEvent:function(a,b){return this.player.off(a,b),this},setMedia:function(a){return this.config.liveURL=a,this.requestMedia(),this},setPoster:function(a){this.player.attr("poster",a)},setUid:function(a){this.config.uid=a},setSid:function(a){this.config.sid=a},setSsid:function(a){this.config.ssid=a}};
